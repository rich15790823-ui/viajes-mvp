<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Vuelos (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Arial, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 8px; }
    .hint { color: #666; font-size: 12px; margin-bottom: 16px; }
    form { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; align-items: end; }
    label { display: block; font-size: 12px; margin-bottom: 6px; }
    input, select, button { padding: 10px; font-size: 14px; width: 100%; box-sizing: border-box; }
    input, select { border: 1px solid #ccc; border-radius: 8px; }
    button { cursor: pointer; border: 0; border-radius: 8px; background:#111; color:#fff; }
    .row-full { grid-column: 1 / -1; }
    #msg { margin-top: 6px; min-height: 20px; font-size: 14px; }
    .error { color: #b00020; }
    .ok { color: #117a00; }
    .muted { color: #666; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; text-align: left; vertical-align: top; }
    th { background: #f5f5f5; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
    .details td { background: #fafafa; }
    button.loading { position: relative; pointer-events: none; opacity: .8; }
    button.loading::after{
      content:""; position:absolute; right:12px; top:50%; width:14px; height:14px;
      margin-top:-7px; border:2px solid #fff; border-top-color: transparent; border-radius:50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <h1>Buscador de Vuelos (MVP)</h1>
  <p class="hint">Ejemplo: <b>CUN</b> → <b>MAD</b>, salida <b>2025-09-01</b>, adultos <b>1</b>.</p>

  <form id="form">
    <div>
      <label for="origin">Origen (IATA)</label>
      <input id="origin" name="origin" value="CUN" maxlength="3" />
    </div>
    <div>
      <label for="destination">Destino (IATA)</label>
      <input id="destination" name="destination" value="MAD" maxlength="3" />
    </div>
    <div>
      <label for="date">Salida (YYYY-MM-DD)</label>
      <input id="date" name="date" value="2025-09-01" />
    </div>
    <div>
      <label for="adults">Adultos</label>
      <input id="adults" name="adults" type="number" min="1" value="1" />
    </div>
    <div>
      <label for="currency">Moneda</label>
      <select id="currency" name="currency">
        <option value="USD" selected>USD</option>
        <option value="MXN">MXN</option>
        <option value="EUR">EUR</option>
      </select>
    </div>
    <div>
      <label><input type="checkbox" id="roundTrip" /> Ida y vuelta</label>
      <div id="returnDateWrap" style="display:none; margin-top:6px;">
        <label for="returnDate">Regreso (YYYY-MM-DD)</label>
        <input id="returnDate" name="returnDate" />
      </div>
    </div>

    <div class="row-full">
      <button id="btn" type="submit">Buscar</button>
      <span id="msg" class="muted"></span>
    </div>
  </form>

  <table id="tabla" style="display:none;">
    <thead>
      <tr>
        <th>Aerolínea</th>
        <th>Salida (ida)</th>
        <th>Llegada (ida)</th>
        <th>Duración (ida)</th>
        <th>Escalas (ida)</th>
        <th>Regreso (llegada)</th>
        <th>Precio</th>
        <th>Detalles</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const form = document.getElementById('form');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const tabla = document.getElementById('tabla');
    const tbody = document.getElementById('tbody');
    const roundTripCheckbox = document.getElementById('roundTrip');
    const returnDateWrap = document.getElementById('returnDateWrap');

    roundTripCheckbox.addEventListener('change', () => {
      returnDateWrap.style.display = roundTripCheckbox.checked ? 'block' : 'none';
    });

    function fmt(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return d.toLocaleString();
    }
    function num(n) {
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.className = 'muted';
      msg.textContent = 'Buscando...';
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'Buscando…';
      tabla.style.display = 'none';
      tbody.innerHTML = '';

      const origin = document.getElementById('origin').value.trim().toUpperCase();
      const destination = document.getElementById('destination').value.trim().toUpperCase();
      const date = document.getElementById('date').value.trim();
      const adults = (document.getElementById('adults').value || '1').trim();
      const currency = document.getElementById('currency').value;
      const returnDate = roundTripCheckbox.checked ? (document.getElementById('returnDate').value || '').trim() : '';

      // Validaciones rápidas
      if (!/^[A-Z]{3}$/.test(origin)) { msg.className='error'; msg.textContent='Origen inválido (IATA, ej. CUN).'; end(); return; }
      if (!/^[A-Z]{3}$/.test(destination)) { msg.className='error'; msg.textContent='Destino inválido (IATA, ej. MAD).'; end(); return; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { msg.className='error'; msg.textContent='Salida inválida (YYYY-MM-DD).'; end(); return; }
      if (roundTripCheckbox.checked && !/^\d{4}-\d{2}-\d{2}$/.test(returnDate)) { msg.className='error'; msg.textContent='Regreso inválido (YYYY-MM-DD).'; end(); return; }

      try {
        const q = new URLSearchParams({ origin, destination, date, adults, currency });
        if (returnDate) q.set('returnDate', returnDate);

        const res = await fetch('/api/vuelos?' + q.toString());
        const data = await res.json();

        if (!res.ok) {
          msg.className = 'error';
          msg.textContent = res.status === 504
            ? 'La búsqueda tardó demasiado (timeout). Intenta otra fecha.'
            : (data?.error || 'Error en la búsqueda.');
          end();
          return;
        }

        const resultados = data.results || [];
        if (resultados.length === 0) {
          msg.className = 'ok';
          msg.textContent = 'Sin resultados. Prueba otras fechas o rutas.';
          end();
          return;
        }

        // Pintar filas (incluye regreso)
        resultados.forEach((r, idx) => {
          const tr = document.createElement('tr');
          const price = r.priceTotal ? `${r.currency || 'USD'} ${num(r.priceTotal)}` : '-';
          const regresoCol = r.hasReturn
            ? `<b>${r.returnArrivalIata || '-'}</b><br><span class="mono">${fmt(r.returnArrivalAt)}</span>`
            : '—';

          tr.innerHTML = `
            <td>${r.airline || '-'}<br><span class="mono">${r.airlineCode || ''}</span></td>
            <td><b>${r.departureIata || '-'}</b><br><span class="mono">${fmt(r.departureAt)}</span></td>
            <td><b>${r.arrivalIata || '-'}</b><br><span class="mono">${fmt(r.arrivalAt)}</span></td>
            <td>${r.duration || '-'}</td>
            <td>${r.stops ?? '-'}</td>
            <td>${regresoCol}</td>
            <td>${price}</td>
            <td><button type="button" data-idx="${idx}" class="btn-detalles">Ver detalles</button></td>
          `;
          tbody.appendChild(tr);

          // Fila de detalles (legs ida y vuelta)
          const trDet = document.createElement('tr');
          trDet.className = 'details';
          const legsOutText = (r.legs || []).map((s, i) =>
            `IDA ${i+1} — ${s.airlineCode} ${s.flightNumber}\n  ${s.from}  ${fmt(s.departAt)}  →  ${s.to}  ${fmt(s.arriveAt)}\n  Duración: ${s.duration || '-'}`
          ).join('\n\n');

          const legsRetText = (r.returnLegs || []).map((s, i) =>
            `VUELTA ${i+1} — ${s.airlineCode} ${s.flightNumber}\n  ${s.from}  ${fmt(s.departAt)}  →  ${s.to}  ${fmt(s.arriveAt)}\n  Duración: ${s.duration || '-'}`
          ).join('\n\n');

          const content = [
            legsOutText ? legsOutText : 'Sin detalle de ida.',
            r.hasReturn ? (legsRetText || 'Sin detalle de vuelta.') : ''
          ].filter(Boolean).join('\n\n');

          trDet.innerHTML = `
            <td colspan="8">
              <div style="display:none" id="det-${idx}">
                <pre>${content}</pre>
              </div>
            </td>`;
          tbody.appendChild(trDet);
        });

        // Toggle detalles (delegado)
        tbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('.btn-detalles');
          if (!btn) return;
          const i = btn.getAttribute('data-idx');
          const panel = document.getElementById(`det-${i}`);
          const visible = panel.style.display !== 'none';
          panel.style.display = visible ? 'none' : 'block';
          btn.textContent = visible ? 'Ver detalles' : 'Ocultar';
        }, { once: true }); // se agrega 1 sola vez

        msg.className = 'ok';
        msg.textContent = `Listo: ${resultados.length} resultado(s).`;
        tabla.style.display = '';
      } catch (e) {
        console.error(e);
        msg.className = 'error';
        msg.textContent = 'Error de red o servidor.';
      } finally {
        end();
      }
    });

    function end() {
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.textContent = 'Buscar';
    }
  </script>
</body>
</html>
